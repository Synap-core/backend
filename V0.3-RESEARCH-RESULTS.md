# V0.3 Research Results

## Research Task #1: Neon + TimescaleDB

**Question**: Does Neon support TimescaleDB extension?

**Answer**: ✅ **YES!** TimescaleDB is supported on Neon.

**Test Results**:
```sql
-- Test command
CREATE EXTENSION IF NOT EXISTS timescaledb;

-- Result
✅ CREATE EXTENSION

-- Verification
SELECT extname, extversion FROM pg_extension WHERE extname = 'timescaledb';

-- Output
extname     | extversion
------------|------------
timescaledb | 2.17.1
```

**Impact**:
- ✅ No separate database needed
- ✅ Same connection string
- ✅ Zero additional cost
- ✅ Simpler architecture
- ✅ Same Drizzle client

**Decision**: Use TimescaleDB on Neon (no Railway/Supabase needed)

---

## Research Task #2: Cloudflare R2

**Question**: How to use Cloudflare R2 with Node.js?

**Answer**: R2 is S3-compatible, use AWS SDK with custom endpoint.

**Key Findings**:

1. **R2 = S3 API**
   - Use `@aws-sdk/client-s3`
   - Change endpoint to `https://ACCOUNT_ID.r2.cloudflarestorage.com`
   - Same commands: PutObject, GetObject, DeleteObject

2. **Setup Steps**:
   ```bash
   # 1. Go to Cloudflare Dashboard
   open https://dash.cloudflare.com/r2
   
   # 2. Create bucket: "synap-storage"
   
   # 3. Generate R2 API Token
   # - Go to "Manage R2 API Tokens"
   # - Create token with "Object Read & Write" permissions
   
   # 4. Copy credentials:
   # - Account ID
   # - Access Key ID
   # - Secret Access Key
   ```

3. **Node.js Usage**:
   ```typescript
   import { S3Client, PutObjectCommand } from '@aws-sdk/client-s3';
   
   const r2 = new S3Client({
     region: 'auto',
     endpoint: `https://${ACCOUNT_ID}.r2.cloudflarestorage.com`,
     credentials: {
       accessKeyId: R2_ACCESS_KEY_ID,
       secretAccessKey: R2_SECRET_ACCESS_KEY,
     },
   });
   
   // Upload
   await r2.send(new PutObjectCommand({
     Bucket: 'synap-storage',
     Key: 'path/to/file.md',
     Body: Buffer.from('content'),
   }));
   ```

4. **Pricing** (vs PostgreSQL and S3):
   ```
   Storage:
   - R2: $0.015/GB/month
   - PostgreSQL: $0.23/GB/month (Neon)
   - S3: $0.023/GB/month
   → R2 is 15x cheaper than PostgreSQL!
   
   Operations:
   - R2: $4.50 per million writes
   - S3: $5.00 per million writes
   - PostgreSQL: Included (but limited)
   
   Egress (downloads):
   - R2: $0 FREE!
   - S3: $0.09/GB
   - PostgreSQL: Included (but limited)
   
   For 10TB storage + 1M operations + 1TB egress:
   - PostgreSQL: $2,300/month
   - S3: $230 + $5 + $90 = $325/month
   - R2: $150 + $5 + $0 = $155/month
   
   → R2 saves $2,145/month (93% reduction!)
   ```

**Decision**: ✅ Use Cloudflare R2 (not S3, not PostgreSQL)

---

## Research Task #3: EventStoreDB vs TimescaleDB

**Question**: Should we use EventStoreDB or TimescaleDB?

**Comparison**:

| Feature | EventStoreDB | TimescaleDB |
|---------|--------------|-------------|
| **Purpose** | Event Sourcing | Time-Series |
| **Cost** | $99/month (cloud) | $0 (on Neon) |
| **Complexity** | Medium | Low |
| **Features** | Projections, Subscriptions | Compression, Continuous Aggregates |
| **Query** | Event-specific | Standard SQL |
| **Scaling** | Excellent | Excellent |
| **Ops** | Separate service | Same DB |

**Decision for V0.3**: **Use TimescaleDB** (simpler, cheaper, SQL)

**Migration Path**:
- V0.3: TimescaleDB (on Neon)
- V1.0: Evaluate EventStoreDB if we need:
  - Complex projections
  - Real-time subscriptions
  - Multi-stream queries
  - Event versioning

---

## Summary

| Research Item | Result | Impact |
|---------------|--------|--------|
| **Neon + TimescaleDB** | ✅ Supported (v2.17.1) | No extra DB needed |
| **Cloudflare R2** | ✅ S3-compatible | 93% storage cost reduction |
| **EventStoreDB** | ⏸️ Deferred to V1.0 | Keep architecture simple |

**Total Cost Savings**:
- Storage: $2,145/month (PostgreSQL → R2)
- Database: $0/month (TimescaleDB on Neon)
- **Total: $2,145/month savings** (from $2,300 → $155/month)

**Architecture Simplification**:
- ✅ Single database (Neon with TimescaleDB extension)
- ✅ S3-compatible storage (R2)
- ✅ Standard SQL queries
- ✅ No additional services

---

## Updated Implementation Plan

**Changes from Original Plan**:

1. **Week 2**: No separate TimescaleDB deployment
   - Just enable extension on Neon
   - Create hypertable in same database
   - Update EventRepository to use Neon connection

2. **Cost**: Reduced from $355/month to $155/month
   - Neon: $100/month (reduced usage)
   - R2: $155/month
   - Inngest: $25/month (reduced)
   - **Total: $155/month** (87% reduction from V0.2)

3. **Complexity**: Reduced
   - 1 database instead of 2
   - 1 connection string
   - Simpler deployment

**Status**: ✅ Research complete, ready to proceed with implementation!

