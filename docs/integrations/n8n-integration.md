# N8N Integration Guide

## Overview

Integrate N8N workflow automation with Synap in **two ways**:

1. **Zero-Config** (.env) - Recommended
2. **Manual** (Admin UI) - For dynamic webhooks

## Zero-Config Setup (.env)

### Step 1: Get N8N Webhook URL

1. Sign up at https://n8n.cloud (free trial)
2. Create new workflow
3. Add "Webhook" trigger node
4. Copy "Production URL" (e.g., `https://yourinstance.app.n8n.cloud/webhook/synap-events`)

### Step 2: Add to .env

```bash
# synap-backend/.env

# N8N Webhook URL (auto-subscribes on server start)
N8N_WEBHOOK_URL=https://yourinstance.app.n8n.cloud/webhook/synap-events

# Event Types (optional - defaults shown)
N8N_EVENT_TYPES=entities.create.validated,entities.update.validated,entities.delete.validated

# Webhook Secret (optional - auto-generated if not set)
N8N_WEBHOOK_SECRET=your-secret-key-123
```

### Step 3: Restart Server

```bash
# Server will auto-create webhook subscription
pnpm dev
```

Check logs for: `✅ Created N8N webhook subscription`

### Step 4: Test

```bash
# Create an entity
curl -X POST 'http://localhost:3000/trpc/notes.create' \
  -H "Content-Type: application/json" \
  -H "x-test-user-id: test" \
  -d '{"title":"Test","content":"Hello N8N!"}'
```

**Check N8N**: Execution should appear in workflow!

---

## Manual Setup (Admin UI)

Use this if:
- You want multiple N8N instances
- Different webhooks for different events
- Dynamic webhook management

### Steps:

1. Open Admin UI: `http://localhost:5173`
2. Go to **Subscribers** page
3. Click **Webhooks** tab
4. Click **+ Add Webhook**
5. Fill in:
   - **Name**: N8N Production
   - **URL**: Your N8N webhook URL
   - **Event Types**: Select events
   - **Secret**: (optional)
6. Save

---

## Event Structure

Events sent to N8N:

```json
{
  "id": "evt_abc123",
  "type": "entities.create.validated",
  "timestamp": "2025-12-15T16:00:00Z",
  "data": {
    "id": "entity_xyz",
    "entityType": "note",
    "title": "My Note",
    "content": "Note content here",
    "userId": "user_123",
    "preview": "Note content...",
    "createdAt": "2025-12-15T16:00:00Z",
    "updatedAt": "2025-12-15T16:00:00Z"
  },
  "metadata": {
    "version": 1,
    "requestId": "req_abc"
  }
}
```

Access in N8N: `{{ $json.data.title }}`, `{{ $json.type }}`, etc.

---

## Example N8N Workflows

### Workflow 1: Slack Notifications

```
Webhook (Synap Events)
  ↓
Filter (only notes)
  ↓
Slack (Send Message)
```

**Filter**: `{{ $json.data.entityType === 'note' }}`

**Slack Message**: `New note created: {{ $json.data.title }}`

### Workflow 2: Auto-Tagging with OpenAI

```
Webhook (Synap Events)
  ↓
OpenAI (Extract tags from content)
  ↓
HTTP Request (Update entity via Synap API)
```

**HTTP Request**:
- Method: POST
- URL: `http://localhost:3000/trpc/entities.update`
- Body:
  ```json
  {
    "id": "{{ $json.data.id }}",
    "tags": "{{ $node['OpenAI'].json.tags }}"
  }
  ```

### Workflow 3: N8N → Synap (Create Entities)

```
Schedule (every hour)
  ↓
Code (Generate report data)
  ↓
HTTP Request (Create entity)
```

**HTTP Request**:
- Method: POST
- URL: `http://localhost:3000/trpc/notes.create`
- Headers:
  ```json
  {
    "Content-Type": "application/json",
    "x-test-user-id": "n8n-bot"
  }
  ```
- Body:
  ```json
  {
    "title": "Hourly Report {{ $now.format('YYYY-MM-DD HH:mm') }}",
    "content": "Generated by N8N"
  }
  ```

---

## Security: HMAC Verification

### In Synap

Already implemented! Synap signs all webhooks with HMAC-SHA256:

```
X-Synap-Signature: sha256=abc123...
```

### In N8N

Add **Code Node** after webhook to verify:

```javascript
const crypto = require('crypto');

// Get secret from N8N credentials store
const secret = '{{$credentials.synapWebhookSecret}}';

// Get signature from headers
const signature = $request.headers['x-synap-signature']?.replace('sha256=', '');

// Compute expected signature
const payload = JSON.stringify($input.item.json);
const expected = crypto
  .createHmac('sha256', secret)
  .update(payload)
  .digest('hex');

// Verify
if (signature !== expected) {
  throw new Error('Invalid signature - webhook rejected');
}

// Signature valid - pass through
return $input.item.json;
```

---

## Troubleshooting

### Webhook not auto-subscribing?

Check logs on server start:
```bash
pnpm dev
# Look for: "✅ Created N8N webhook subscription"
```

If missing:
1. Check `N8N_WEBHOOK_URL` in `.env`
2. Verify it's a valid URL
3. Check server logs for errors

### N8N not receiving events?

1. **Check Admin UI**:
   - Go to Subscribers → Webhooks
   - Verify webhook exists and is active
   - Check URL is correct

2. **Check Inngest**:
   - Open http://localhost:8288/runs
   - Look for "Webhook Broker" runs
   - Check if delivery succeeded

3. **Test with webhook.site**:
   ```bash
   # Get unique URL from webhook.site
   # Add as webhook in .env or Admin UI
   # Create entity - check if webhook.site receives it
   ```

### N8N workflow not triggering?

- Check N8N execution history (right panel)
- Verify webhook is in "Production" mode, not "Test URL"
- Check N8N logs for errors
- Test with manual execution first

---

## Available Events

### Entity Events
- `entities.create.validated` - Entity created
- `entities.update.validated` - Entity updated
- `entities.delete.validated` - Entity deleted

### Message Events
- `conversationMessages.create.validated` - Message sent
- `conversationMessages.update.validated` - Message edited

### Document Events
- `documents.create.validated` - Document uploaded
- `documents.update.validated` - Document modified

See [docs/api/event-types-catalog.md](../api/event-types-catalog.md) for all 55+ events.

---

## Advanced: Multiple N8N Instances

Use Admin UI to add multiple webhooks:

```
Webhook 1: Production N8N (all events)
Webhook 2: Staging N8N (only test events)
Webhook 3: Development N8N (specific events)
```

Each gets its own subscription with different event filters.

---

## Next Steps

- ✅ Basic webhook working
- ⏭️ Create production workflows
- ⏭️ Add LangFlow integration
- ⏭️ Build custom automations

See [../automation/n8n-examples.md](../automation/n8n-examples.md) for more workflow examples.
